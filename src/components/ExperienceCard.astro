---
import type { Bullet } from '../data/experience';

interface Props {
    company: string;
    role: string;
    duration: string;
    bullets: Bullet[];
    url: string;
    image?: string;
    index: number;
    total: number;
}

const { company, role, duration, bullets, url, image, index, total } = Astro.props;

function renderBullet(bullet: Bullet): string {
    let html = bullet.text;
    for (const highlight of bullet.highlights) {
        html = html.replace(
            highlight,
            `<span style="color: var(--color-accent);">${highlight}</span>`,
        );
    }
    return html;
}

/**
 * Derive start/end labels for flanking the content:
 *   "May 2024 — Present" → { start: "SINCE", end: "2024" }
 *   "Oct 2020 — Aug 2023" → { start: "2020", end: "2023" }
 *   "Jan 2018 — Aug 2019" → { start: "2018", end: "2019" }
 */
function getDurationParts(dur: string): { start: string; end: string } {
    if (dur.toLowerCase().includes('present')) {
        const yearMatch = dur.match(/(\d{4})/);
        return { start: 'SINCE', end: yearMatch?.[1] ?? '' };
    }
    const years = dur.match(/(\d{4})/g);
    if (years && years.length >= 2) {
        return { start: years[0], end: years[1] };
    }
    return { start: dur, end: '' };
}

const { start: durationStart, end: durationEnd } = getDurationParts(duration);
---

<article class="experience-card">
    <hr class="experience-separator" />
    <div class="experience-card-grid">
        <div class="experience-card-index">
            {durationStart}
        </div>
        <div class="experience-card-content">
            <div class="experience-card-header">
                <h3 class="experience-card-company">{company}</h3>
                <div class="experience-card-meta">
                    <span class="experience-card-role">{role}</span>
                </div>
            </div>
            <div class="experience-card-body">
                <div class="experience-card-body-inner">
                    <div class="experience-card-body-text">
                        <ul class="experience-card-bullets">
                            {bullets.map((bullet) => (
                                <li set:html={renderBullet(bullet)} />
                            ))}
                        </ul>
                        <a href={url} target="_blank" rel="noopener noreferrer" class="experience-card-cta flip-link">
                            {('View on LinkedIn ↗').split('').map((char, i) => (
                                <span class="flip-link-char">
                                    <span class="flip-link-char-inner" style={`transition-delay: ${i * 0.015}s;`}>
                                        <span>{char === ' ' ? '\u00A0' : char}</span>
                                        <span>{char === ' ' ? '\u00A0' : char}</span>
                                    </span>
                                </span>
                            ))}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {image && (
            <div class="experience-card-image">
                <img src={image} alt="" loading="lazy" />
            </div>
        )}
        <div class="experience-card-index experience-card-index-end">
            {durationEnd}
        </div>
    </div>
</article>
